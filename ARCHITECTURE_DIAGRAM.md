# AsterDEX Trading Bot 架构图

## 系统总览

```
┌─────────────────────────────────────────────────────────────────────┐
│                    AsterDEX Trading Bot                             │
│                                                                     │
│  ┌──────────────┐      ┌──────────────┐      ┌──────────────┐    │
│  │   Scheduler  │      │   Strategy   │      │     Risk     │    │
│  │  (APScheduler)│────▶│ (DoubleMa)   │────▶│  Management  │    │
│  │              │      │              │      │              │    │
│  │  • 15m: 5min │      │ • SMA 20/60  │      │ • Max 30%    │    │
│  │  • 4h: 1hour │      │ • EMA 120    │      │ • Isolated   │    │
│  └──────────────┘      │ • Convergence│      │ • 5x Leverage│    │
│                        │ • Breakout   │      └──────────────┘    │
│                        └──────────────┘                           │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
                        ┌──────────────┐
                        │   Trader     │
                        │  (执行引擎)   │
                        └──────────────┘
                                │
                                ▼
```

## 交易信号决策流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                        Trading Signal Flow                           │
└─────────────────────────────────────────────────────────────────────┘

    Strategy 生成信号
            │
            ├─── action: BUY/SELL/CLOSE/HOLD
            ├─── confidence: 0-100
            ├─── reason: 说明
            └─── ma_data: 技术指标数据
            │
            ▼
    ┌──────────────────┐
    │ action == HOLD?  │────YES────▶ 不执行任何操作
    └──────────────────┘
            │ NO
            ▼
    ┌──────────────────┐
    │ action == CLOSE? │────YES────▶ 平仓逻辑
    └──────────────────┘
            │ NO
            ▼
    ┌──────────────────┐
    │已有持仓？         │────YES────▶ 跳过开仓
    └──────────────────┘
            │ NO
            ▼
    ┌──────────────────┐
    │ 风险等级 HIGH?   │────YES────▶ 拒绝开仓
    └──────────────────┘
            │ NO
            ▼
    ┌──────────────────────────────────────────┐
    │         DeepSeek 增强决策                 │
    │    (仅当 confidence < 90 时触发)          │
    └──────────────────────────────────────────┘
            │
            ▼
```

## DeepSeek 兜底逻辑详细流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                    DeepSeek Fallback Logic                           │
└─────────────────────────────────────────────────────────────────────┘

    信号: confidence < 90
            │
            ▼
    ┌──────────────────┐
    │ 配置了 DeepSeek? │────NO────▶ 直接执行本地策略 ────┐
    └──────────────────┘                                  │
            │ YES                                         │
            ▼                                             │
    ┌──────────────────────────────────────┐            │
    │  try:                                 │            │
    │      调用 DeepSeek API                │            │
    │      ├─ get_market_sentiment()       │            │
    │      └─ analyze_trading_signal()     │            │
    │  except Exception as e:               │            │
    │      捕获所有异常                      │            │
    └──────────────────────────────────────┘            │
            │                                             │
            ├─────API 成功────┐                          │
            │                 │                          │
            │                 ▼                          │
            │         ┌──────────────┐                  │
            │         │ AI 分析结果   │                  │
            │         └──────────────┘                  │
            │                 │                          │
            │                 ├─ action: BUY            │
            │                 ├─ action: SELL           │
            │                 └─ action: HOLD ───▶ 跳过开仓
            │                                             │
            └─────API 失败────┐                          │
                              ▼                          │
                    ┌──────────────────┐                │
                    │ 记录警告日志      │                │
                    │ "AI 分析异常"     │                │
                    └──────────────────┘                │
                              │                          │
                              ▼                          │
                    返回原始信号动作 ────────────────────┤
                    (不阻止交易)                         │
                                                         │
                                                         ▼
                                              ┌──────────────────┐
                                              │  执行本地策略    │
                                              │                  │
                                              │  • 计算仓位大小   │
                                              │  • 验证订单      │
                                              │  • 调用 AsterDEX │
                                              │  • 下单          │
                                              └──────────────────┘
```

## 三种运行模式对比

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Operating Modes                              │
└─────────────────────────────────────────────────────────────────────┘

模式 1: 纯本地模式
┌──────────────────────────────────────────────────────┐
│  配置: deepseek.api_key = ""                         │
│                                                       │
│  策略信号 ────▶ 风险检查 ────▶ 直接下单              │
│                                                       │
│  特点:                                                │
│  ✅ 零外部依赖                                        │
│  ✅ 响应最快（无网络延迟）                             │
│  ✅ 完整交易功能                                      │
│  ⚠️  无 AI 辅助分析                                   │
└──────────────────────────────────────────────────────┘

模式 2: 降级模式（兜底）
┌──────────────────────────────────────────────────────┐
│  触发: DeepSeek API 配置了但调用失败                  │
│                                                       │
│  策略信号 ────▶ 尝试 AI ────✗ 失败 ────▶ 本地策略    │
│                            │                         │
│                            └─▶ 记录警告              │
│                                                       │
│  特点:                                                │
│  ✅ 自动降级                                          │
│  ✅ 不影响交易                                        │
│  📝 详细错误日志                                      │
│  ⏱️  初次尝试有延迟（后续缓存失败状态）                │
└──────────────────────────────────────────────────────┘

模式 3: 增强模式
┌──────────────────────────────────────────────────────┐
│  配置: deepseek.api_key = "sk-xxx"                   │
│                                                       │
│  策略信号 ────┬─▶ confidence >= 90 ────▶ 直接下单   │
│               │                                       │
│               └─▶ confidence < 90 ────┐              │
│                                       ▼              │
│                              ┌────────────────┐     │
│                              │ AI 二次确认     │     │
│                              │ • 市场情绪      │     │
│                              │ • 风险评估      │     │
│                              └────────────────┘     │
│                                       │              │
│                                       ▼              │
│                              AI 建议 + 本地策略       │
│                                                       │
│  特点:                                                │
│  ✅ AI 增强决策                                       │
│  ✅ 高置信度信号快速执行                               │
│  🤖 低置信度信号 AI 确认                              │
│  ⏱️  低置信度信号有 1-2s 延迟                         │
└──────────────────────────────────────────────────────┘
```

## 风险管理流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                      Risk Management Flow                            │
└─────────────────────────────────────────────────────────────────────┘

    准备开仓
        │
        ▼
    ┌──────────────────────┐
    │ 获取账户余额          │
    │ • 可用 USDT           │
    │ • 已用保证金          │
    └──────────────────────┘
        │
        ▼
    ┌──────────────────────┐
    │ 检查现有持仓          │
    │ • 4 个币对            │
    │ • 保证金使用率        │
    └──────────────────────┘
        │
        ▼
    ┌──────────────────────┐      NO
    │ 保证金使用率 < 30%?  │──────────▶ 拒绝开仓
    └──────────────────────┘
        │ YES
        ▼
    ┌──────────────────────┐
    │ 计算仓位大小          │
    │ • 可用余额 * 30%     │
    │ • 应用杠杆 (5x)      │
    │ • 计算合约数量        │
    └──────────────────────┘
        │
        ▼
    ┌──────────────────────┐
    │ 应用交易所过滤器      │
    │ • LOT_SIZE           │
    │ • PRICE_FILTER       │
    │ • MIN_NOTIONAL       │
    └──────────────────────┘
        │
        ▼
    ┌──────────────────────┐      NO
    │ 验证订单有效性？      │──────────▶ 拒绝开仓
    └──────────────────────┘
        │ YES
        ▼
    ┌──────────────────────┐
    │ 下市价单              │
    │ • EIP-712 签名       │
    │ • AsterDEX API       │
    └──────────────────────┘
        │
        ▼
    ┌──────────────────────┐
    │ 记录订单信息          │
    │ • 入场价格            │
    │ • 数量                │
    │ • 保证金              │
    └──────────────────────┘
```

## 技术指标计算流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                    Technical Indicators Flow                         │
└─────────────────────────────────────────────────────────────────────┘

    获取 K 线数据
    (15m 或 4h)
        │
        ▼
    ┌──────────────────────┐
    │ 计算 SMA              │
    │ • period: 20         │
    │ • period: 60         │
    │ • period: 120        │
    └──────────────────────┘
        │
        ▼
    ┌──────────────────────┐
    │ 计算 EMA              │
    │ • period: 20         │
    │ • period: 60         │
    │ • period: 120        │
    └──────────────────────┘
        │
        ▼
    ┌──────────────────────────────────────┐
    │ 检测均线收敛                          │
    │                                       │
    │ max_ma - min_ma                      │
    │ ─────────────── × 100 <= 2%         │
    │     max_ma                           │
    └──────────────────────────────────────┘
        │
        ├─ YES ─▶ 标记收敛时间
        │
        └─ NO ──▶ 等待收敛
        │
        ▼
    ┌──────────────────────────────────────┐
    │ 检测价格突破                          │
    │                                       │
    │ • 突破上方 ─▶ 做多信号                │
    │ • 突破下方 ─▶ 做空信号                │
    │ • 未突破 ───▶ 继续等待                │
    └──────────────────────────────────────┘
        │
        ▼
    ┌──────────────────────────────────────┐
    │ 确认期（30分钟）                       │
    │                                       │
    │ • 价格稳定在突破方向                   │
    │ • 未发生反转                          │
    └──────────────────────────────────────┘
        │
        ▼
    生成交易信号
    (action + confidence)
```

## 系统部署架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                      Deployment Architecture                         │
└─────────────────────────────────────────────────────────────────────┘

    开发环境                  生产环境（Linux Server）
    ─────────                ─────────────────────────

    ┌─────────────┐          ┌──────────────────────┐
    │ Git Repo    │          │   systemd service    │
    │ (GitHub)    │────────▶│  asterdex-bot.service│
    └─────────────┘          └──────────────────────┘
                                      │
                                      ▼
                             ┌──────────────────────┐
                             │  Virtual Environment  │
                             │  • Python 3.8+       │
                             │  • Dependencies      │
                             └──────────────────────┘
                                      │
                                      ▼
                             ┌──────────────────────┐
                             │   Bot Process        │
                             │  • APScheduler       │
                             │  • 15m 任务: 5分钟    │
                             │  • 4h 任务: 1小时     │
                             └──────────────────────┘
                                      │
                    ┌─────────────────┴─────────────────┐
                    │                                   │
                    ▼                                   ▼
           ┌────────────────┐              ┌────────────────┐
           │ AsterDEX API   │              │ DeepSeek API   │
           │ (Required)     │              │ (Optional)     │
           │                │              │                │
           │ • K线数据      │              │ • 市场情绪     │
           │ • 账户信息     │              │ • AI分析       │
           │ • 下单         │              └────────────────┘
           │ • EIP-712签名  │
           └────────────────┘

    日志文件                  配置文件
    ─────────                ─────────
    
    logs/                    config/
    ├── bot.log              └── config.json
    │   ├── 交易记录                ├── asterdex (必需)
    │   ├── 错误信息                ├── deepseek (可选)
    │   └── 性能指标                ├── trading
                                    └── symbols
```

## 错误处理层级

```
┌─────────────────────────────────────────────────────────────────────┐
│                      Error Handling Layers                           │
└─────────────────────────────────────────────────────────────────────┘

    Layer 1: Scheduler 层
    ────────────────────
    try:
        执行定时任务
    except Exception as e:
        记录错误，继续下次调度
        不影响其他任务

    Layer 2: Strategy 层
    ────────────────────
    try:
        计算技术指标
        生成交易信号
    except Exception as e:
        返回 HOLD 信号
        记录错误

    Layer 3: DeepSeek 层 (新增!)
    ────────────────────────────
    if self.deepseek:
        try:
            调用 AI API
        except Exception as e:
            记录警告 ───▶ 不阻止交易
            返回原始信号 ───▶ 使用本地策略

    Layer 4: Trader 层
    ──────────────────
    try:
        风险检查
        计算仓位
        下单
    except Exception as e:
        记录错误
        不影响其他币对

    Layer 5: API 层
    ───────────────
    try:
        HTTP 请求
        EIP-712 签名
    except Exception as e:
        记录详细错误
        返回失败状态
```

---

**架构版本**: v1.0  
**最后更新**: 2025-10-22  
**状态**: ✅ 已部署到生产环境
